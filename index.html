<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Landing Page</title>
    <style>

        body {
            text-align: center;
        }

        .button {
            background-color: #e7e7e7;
            border: none;
            color: black;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 10px;
            margin: 20px 2px;
        }

        .videoWrapper {
            perspective: 20cm;
            /* A <length> giving the distance from the user(our case: camera) to the z=0 plane (our case: table through reflection). It is used to apply a perspective transform to the children of the element. */
            /* top: 0;
            left: 0;
            width: 100%;
            height: 100%; */
            /* text-align: center; */
            overflow: hidden;
        }

        #c2 {
            position: relative;
            transform: rotateX(20deg) scaleX(-1);
        }
    </style>
</head>

<body>
    <h1>Activity List</h1>
    <div class="buttonList">
        <button class="button" onClick="window.location.href='./activity/masterpiece';">
            Masterpiece
        </button>
        <button class="button" onClick="window.location.href='./activity/calculation';">
            Calculation
        </button>
        <button class="button" onClick="window.location.href='./activity/colormatching';">
            Color Matching
        </button>
    </div>


    <h1>Optical Correction</h1>
    <video autoplay width="200" height="auto"></video>
    <div id="resText"></div>
    <canvas id="c1" width="200" height="auto"></canvas>
    <div>Video to canvas (30fps)</div>

    <div class="videoWrapper">
        <canvas id="c2" width="200" height="auto"></canvas>
    </div>


    <script>
        // Put variables in global scope to make them available to the browser console.
        const video = document.querySelector('video');
        const resText = document.getElementById('resText');
        const c1 = document.getElementById('c1');
        const ctx1 = c1.getContext('2d');
        const c2 = document.getElementById('c2');
        const ctx2 = c2.getContext('2d');

        const constraints = {
            audio: false,
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        };

        navigator.mediaDevices.getUserMedia(constraints)
            .then((stream) => {
                const videoTracks = stream.getVideoTracks();
                console.log('Got stream with constraints:', constraints);
                console.log(`Using video device: ${videoTracks[0].label}`);
                stream.onremovetrack = () => {
                    console.log('Stream ended');
                };
                video.srcObject = stream;

                let stream_settings = videoTracks[0].getSettings();
                resText.textContent = `Camera Stream (${stream_settings.width}x${stream_settings.height})`;
            })
            .catch((error) => {
                if (error.name === 'ConstraintNotSatisfiedError') {
                    console.error(
                        `The resolution ${constraints.video.width.exact}x${constraints.video.height.exact} px is not supported by your device.`
                    );
                } else if (error.name === 'PermissionDeniedError') {
                    console.error(
                        'Permissions have not been granted to use your camera and ' +
                        'microphone, you need to allow the page access to your devices in ' +
                        'order for the demo to work.'
                    );
                } else {
                    console.error(`getUserMedia error: ${error.name}`, error);
                }
            });


        video.addEventListener('play', function () {
            const $this = this; //cache
            (function loop() {
                if (!$this.paused && !$this.ended) {
                    ctx1.drawImage($this, 0, 0, 200, 200 * $this.videoHeight / $this.videoWidth);
                    ctx2.drawImage($this, 0, 0, 200, 200 * $this.videoHeight / $this.videoWidth);
                    let imgData = ctx1.getImageData(0, 0, 200, 200 * $this.videoHeight / $this.videoWidth);
                    let data = imgData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        let r = data[i];
                        let g = data[i + 1];
                        let b = data[i + 2];
                        let a = data[i + 3];
                        let gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        data[i] = gray;
                        data[i + 1] = gray;
                        data[i + 2] = gray;
                        data[i + 3] = a;
                    }
                    ctx2.putImageData(imgData, 0, 0);
                    setTimeout(loop, 1000 / 30); // drawing at 30fps
                }
            })();
        }, 0);
    </script>
</body>

</html>