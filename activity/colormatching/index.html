<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Matching</title>
    <style>
        body {

            margin: 0;
        }

        #container {
            background-size: cover;
        }


        .videoWrapper {
            perspective: 20cm;
            /* A <length> giving the distance from the user(our case: camera) to the z=0 plane (our case: table through reflection). It is used to apply a perspective transform to the children of the element. */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            overflow: hidden;

        }

        video {
            position: relative;
            top: -10%;
            transform: rotateX(20deg) scaleX(-1) scaleY(1.5) scale(1.5);
        }

        .colorWrapper {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .colorContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            /* height: 200px; */
        }

        .colorItem {
            position: absolute;
            display: inline-block;
        }

        .checkmark {
            position: absolute;
            top: 0;
        }
    </style>
</head>

<body onload="initialize()">

    <div id="container">
        <div class="videoWrapper">
            <video autoplay id="videoElement"></video>
        </div>

        <div id="message">
        </div>

        <div class="colorWrapper">

            <div class="colorContainer">
                <div>
                    <div>
                        <img class=“colorItem” src="./colordots/placeholder.svg" id="color1" height="150px"
                            width="150px">
                    </div>
                    <!-- <img class=“placeLocation” src="./colordots/empty.svg" height="150px" width="150px"> -->
                    <img class="checkmark" src="./colordots/checkmark.svg" id="check1" height="150px" width="150px">
                </div>

                <div>
                    <div>
                        <img class=“colorItem” src="./colordots/placeholder.svg" id="color2" height="150px"
                            width="150px">
                    </div>
                    <!-- <img class=“placeLocation” src="./colordots/empty.svg" height="150px" width="150px"> -->
                    <img class="checkmark" src="./colordots/checkmark.svg" id="check2" height="150px" width="150px">
                </div>

                <div>
                    <div>
                        <img class=“colorItem” src="./colordots/placeholder.svg" id="color3" height="150px"
                            width="150px">
                    </div>
                    <!-- <img class=“placeLocation” src="./colordots/empty.svg" height="150px" width="150px"> -->
                    <img class="checkmark" src="./colordots/checkmark.svg" id="check3" height="150px" width="150px">
                </div>

                <div>
                    <div>
                        <img class=“colorItem” src="./colordots/placeholder.svg" id="color4" height="150px"
                            width="150px">
                    </div>
                    <!-- <img class=“placeLocation” src="./colordots/empty.svg" height="150px" width="150px"> -->
                    <img class="checkmark" src="./colordots/checkmark.svg" id="check4" height="150px" width="150px">
                </div>

                <div>
                    <div>
                        <img class=“colorItem” src="./colordots/placeholder.svg" id="color5" height="150px"
                            width="150px">
                    </div>
                    <!-- <img class=“placeLocation” src="./colordots/empty.svg" height="150px" width="150px"> -->
                    <img class="checkmark" src="./colordots/checkmark.svg" id="check5" height="150px" width="150px">
                </div>

            </div>

            <div class="aimLoction">
                <img class=“placeLocation” src="./colordots/empty.svg" height="146px">
                <img class=“placeLocation” src="./colordots/empty.svg" height="146px">
                <img class=“placeLocation” src="./colordots/empty.svg" height="146px">
                <img class=“placeLocation” src="./colordots/empty.svg" height="146px">
                <img class=“placeLocation” src="./colordots/empty.svg" height="146px">
            </div>
        </div>
    </div>




    <script>
        const video = document.querySelector('video');

        const check1 = document.getElementById('check1');
        const check2 = document.getElementById('check2');
        const check3 = document.getElementById('check3');
        const check4 = document.getElementById('check4');
        const check5 = document.getElementById('check5');

        function initialize() {
            check1.style.visibility = "hidden";
            check2.style.visibility = "hidden";
            check3.style.visibility = "hidden";
            check4.style.visibility = "hidden";
            check5.style.visibility = "hidden";
        }

        const constraints = {
            audio: false,
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        };

        navigator.mediaDevices.getUserMedia(constraints)
            .then((stream) => {
                const videoTracks = stream.getVideoTracks();
                console.log('Got stream with constraints:', constraints);
                console.log(`Using video device: ${videoTracks[0].label}`);
                stream.onremovetrack = () => {
                    console.log('Stream ended');
                };
                video.srcObject = stream;

                let stream_settings = videoTracks[0].getSettings();
            })
            .catch((error) => {
                if (error.name === 'ConstraintNotSatisfiedError') {
                    console.error(
                        `The resolution ${constraints.video.width.exact}x${constraints.video.height.exact} px is not supported by your device.`
                    );
                } else if (error.name === 'PermissionDeniedError') {
                    console.error(
                        'Permissions have not been granted to use your camera and ' +
                        'microphone, you need to allow the page access to your devices in ' +
                        'order for the demo to work.'
                    );
                } else {
                    console.error(`getUserMedia error: ${error.name}`, error);
                }
            });

        video.style.width = window.innerWidth + "px";

        let videoWrapper = document.querySelector(".videoWrapper");
        videoWrapper.style.height = window.innerHeight + "px";


        let color1 = document.getElementById("color1");
        let color2 = document.getElementById("color2");
        let color3 = document.getElementById("color3");
        let color4 = document.getElementById("color4");
        let color5 = document.getElementById("color5");


        const colorName = ["red", "blue", "green", "yellow", "orange", "purple"];
        let colorArray = [[192, 0, 0], [0, 112, 192], [0, 176, 80], [255, 192, 0], [237, 125, 49], [104, 51, 156]];

        let targetColor = [[238, 61, 61], [71, 128, 208], [49, 165, 92], [247, 198, 61], [250, 136, 65], [89, 31, 141]];

        let colorLowerBound = [[190, 0, 0], [0, 110, 150], [0, 150, 80], [240, 150, 0], [237, 120, 50], [80, 25, 130]];
        let colorUpperBound = [[255, 70, 70], [80, 150, 255], [60, 176, 100], [255, 255, 70], [255, 150, 70], [104, 51, 160]];


        let givenColorIndex = Math.floor(Math.random() * 6);
        console.log("The given color is " + colorName[givenColorIndex]);
        color3.src = "./colordots/" + colorName[givenColorIndex] + ".svg";

        video.addEventListener('play', function () {
            const $this = this; //cache
            (function loop() {
                if (!$this.paused && !$this.ended) {
                    const canvas = document.createElement('canvas');

                    canvas.width = 240;
                    canvas.height = 320;

                    let ctx = canvas.getContext('2d');
                    ctx.drawImage($this, 0, 0, 240, 320);

                    let imageData = flipImage(ctx.getImageData(0, 0, 240, 320));

                    let colors = getColors(imageData);

                    // console.log(colors[2]);

                    if (colors[2][0] >= colorLowerBound[givenColorIndex][0] && colors[2][0] <= colorUpperBound[givenColorIndex][0] && colors[2][1] >= colorLowerBound[givenColorIndex][1] && colors[2][1] <= colorUpperBound[givenColorIndex][1] && colors[2][2] >= colorLowerBound[givenColorIndex][2] && colors[2][2] <= colorUpperBound[givenColorIndex][2]) {
                        check3.style.visibility = "visible";
                        console.log("The color is correct");
                        //one second delay after answer is correct
                        setTimeout(function () {
                            // New round after the sleep!
                            check3.style.visibility = "hidden";
                            givenColorIndex = Math.floor(Math.random() * 6);
                            console.log("The given color is " + colorName[givenColorIndex]);
                            color3.src = "./colordots/" + colorName[givenColorIndex] + ".svg";
                        }, 2000);
                        // TODO: Should be replaced with a function that moves to the next level
                    } else {
                        check3.style.visibility = "hidden";
                    }

                    setTimeout(loop, 1000 / 30); // drawing at 30fps
                }
            })();
        }, 0);

        function sleep(milliseconds) {
            const date = Date.now();
            let currentDate = null;
            do {
                currentDate = Date.now();
            } while (currentDate - date < milliseconds);
        }


        function flipImage(imageData) {
            // Traverse every row and flip the pixels
            for (i = 0; i < imageData.height; i++) {
                // We only need to do half of every row since we're flipping the halves
                for (j = 0; j < imageData.width / 2; j++) {
                    var index = (i * 4) * imageData.width + (j * 4);
                    var mirrorIndex = ((i + 1) * 4) * imageData.width - ((j + 1) * 4);
                    for (p = 0; p < 4; p++) {
                        var temp = imageData.data[index + p];
                        imageData.data[index + p] = imageData.data[mirrorIndex + p];
                        imageData.data[mirrorIndex + p] = temp;
                    }
                }
            }
            return imageData;
        }

        function getColors(imageData) {
            let colors = [];
            let data = imageData.data;
            for (let i = 2; i <= 6; i += 1) {
                point = []
                startIndex = (imageData.width * imageData.height / 2 + i * imageData.width / 8) * 4;
                for (j = 0; j < 3; j++) {
                    point.push(data[startIndex + j]);
                }
                colors.push(point);
            }
            return colors;
        }

    </script>



</body>

</html>